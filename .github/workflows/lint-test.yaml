name: Lint and Test Charts

on: pull_request

jobs:
  lint-test:
    runs-on: ubuntu-latest
    env:
      CT_TARGET_BRANCH: main
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.4.0

      - uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - name: Setup Vault
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install vault

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.1.0

      - name: Run chart-testing (list-changed)
        id: list-changed
        run: |
          changed=$(ct list-changed)
          if [[ -n "$changed" ]]; then
            echo "::set-output name=changed::true"
          fi

      - name: Run chart-testing (lint)
        run: ct lint

      - name: Create KIND cluster with Registry
        # uses: helm/kind-action@v1.2.0
        uses: container-tools/kind-action@v1
        if: steps.list-changed.outputs.changed == 'true'

      - name: Install Vault Service
        run: |
          kubectl create ns vault
          helm repo add hashicorp https://helm.releases.hashicorp.com
          helm upgrade --install vault hashicorp/vault --namespace=vault --version=0.18.0 --set server.dev.enabled=true --set injector.enabled=false
          sleep 10s
          kubectl wait pod/vault-0 --namespace=vault  --for=condition=Ready --timeout=180s

      - name: Configure vault for kubernetes authentication
        run: |
          kubectl port-forward --namespace vault vault-0 8200 &
          sleep 10s
          vault login root
          kubectl create serviceaccount --namespace kube-system vault-auth
          kubectl create clusterrolebinding vault-auth-kube --clusterrole system:auth-delegator --serviceaccount kube-system:vault-auth
          VAULT_SECRET_NAME=$(kubectl get sa vault-auth --output jsonpath="{.secrets[*]['name']}")
          SA_JWT_TOKEN=$(kubectl get secret $VAULT_SA_NAME --output 'go-template={{ .data.token }}' | base64 --decode)
          SA_CA_CRT=$(kubectl config view --raw --minify --flatten --output 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode)
          env | grep -E 'VAULT_SECRET_NAME|SA_JWT_TOKEN|SA_CA_CRT'
          vault auth enable kubernetes
          vault write auth/kubernetes/config token_reviewer_jwt="$SA_JWT_TOKEN" kubernetes_host="https://kubernetes.default.svc" kubernetes_ca_cert="$SA_CA_CRT" issuer="https://kubernetes.default.svc.cluster.local"


      - name: Run chart-testing (install)
        run: ct install
